generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                String            @id @default(cuid())
  name              String
  slug              String            @unique
  domain            String?           @unique
  settings          Json?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  areas             Area[]
  campaigns         Campaign[]
  customers         Customer[]
  inventories       Inventory[]
  notifications     Notification[]
  orders            Order[]
  productCategories ProductCategory[]
  products          Product[]
  regions           Region[]
  routes            Route[]
  stores            Store[]
  surveys           Survey[]
  users             User[]

  @@map("tenants")
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  firstName           String
  lastName            String
  phone               String?
  avatar              String?
  role                UserRole
  status              UserStatus           @default(ACTIVE)
  lastLoginAt         DateTime?
  settings            Json?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  tenantId            String
  auditLogs           AuditLog[]
  commissions         Commission[]
  merchandisingVisits MerchandisingVisit[]
  notifications       Notification[]
  orders              Order[]
  promoterActivities  PromoterActivity[]
  routes              Route[]
  simDistributions    SimDistribution[]
  surveyResponses     SurveyResponse[]     @relation("SurveyRespondent")
  surveysCreated      Survey[]             @relation("SurveyCreator")
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vanSalesLoads       VanSalesLoad[]

  @@map("users")
}

model ProductCategory {
  id          String            @id @default(cuid())
  code        String
  name        String
  description String?
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  tenantId    String
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  tenant      Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products    Product[]

  @@unique([tenantId, code])
  @@map("product_categories")
}

model Product {
  id             String             @id @default(cuid())
  sku            String
  name           String
  description    String?
  brand          String?
  categoryId     String
  unitPrice      Decimal
  costPrice      Decimal
  weight         Decimal?
  dimensions     Json?
  barcode        String?
  imageUrl       String?
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  tenantId       String
  inventories    Inventory[]
  orderItems     OrderItem[]
  priceHistories PriceHistory[]
  category       ProductCategory    @relation(fields: [categoryId], references: [id])
  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loadItems      VanSalesLoadItem[]

  @@unique([tenantId, sku])
  @@map("products")
}

model PriceHistory {
  id        String   @id @default(cuid())
  price     Decimal
  reason    String?
  createdAt DateTime @default(now())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("price_histories")
}

model Customer {
  id           String       @id @default(cuid())
  code         String
  name         String
  email        String?
  phone        String?
  address      String?
  city         String?
  state        String?
  country      String?
  coordinates  Json?
  customerType CustomerType
  creditLimit  Decimal?
  paymentTerms String?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  tenantId     String
  routeId      String?
  route        Route?       @relation(fields: [routeId], references: [id])
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders       Order[]
  routeStops   RouteStop[]

  @@unique([tenantId, code])
  @@map("customers")
}

model Region {
  id          String   @id @default(cuid())
  code        String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenantId    String
  areas       Area[]
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@map("regions")
}

model Area {
  id          String   @id @default(cuid())
  code        String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenantId    String
  regionId    String
  region      Region   @relation(fields: [regionId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  routes      Route[]

  @@unique([tenantId, code])
  @@map("areas")
}

model Route {
  id                String         @id @default(cuid())
  name              String
  description       String?
  startTime         DateTime?
  endTime           DateTime?
  status            RouteStatus    @default(PLANNED)
  totalDistance     Decimal?
  estimatedDuration Int?
  actualDuration    Int?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  tenantId          String
  areaId            String
  userId            String
  customers         Customer[]
  stops             RouteStop[]
  area              Area           @relation(fields: [areaId], references: [id])
  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user              User           @relation(fields: [userId], references: [id])
  loads             VanSalesLoad[]

  @@map("routes")
}

model RouteStop {
  id          String     @id @default(cuid())
  sequence    Int
  plannedTime DateTime?
  actualTime  DateTime?
  status      StopStatus @default(PENDING)
  notes       String?
  coordinates Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  routeId     String
  customerId  String
  customer    Customer   @relation(fields: [customerId], references: [id])
  route       Route      @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@map("route_stops")
}

model VanSalesLoad {
  id             String                  @id @default(cuid())
  loadNumber     String
  loadDate       DateTime
  totalValue     Decimal
  status         LoadStatus              @default(LOADED)
  notes          String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  userId         String
  routeId        String?
  items          VanSalesLoadItem[]
  route          Route?                  @relation(fields: [routeId], references: [id])
  user           User                    @relation(fields: [userId], references: [id])
  reconciliation VanSalesReconciliation?

  @@map("van_sales_loads")
}

model VanSalesLoadItem {
  id         String       @id @default(cuid())
  quantity   Int
  unitPrice  Decimal
  totalValue Decimal
  loadId     String
  productId  String
  load       VanSalesLoad @relation(fields: [loadId], references: [id], onDelete: Cascade)
  product    Product      @relation(fields: [productId], references: [id])

  @@map("van_sales_load_items")
}

model VanSalesReconciliation {
  id                 String       @id @default(cuid())
  cashCollected      Decimal
  cashExpected       Decimal
  cashVariance       Decimal
  stockReturned      Json
  stockSold          Json
  notes              String?
  reconciliationDate DateTime
  createdAt          DateTime     @default(now())
  loadId             String       @unique
  load               VanSalesLoad @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@map("van_sales_reconciliations")
}

model Order {
  id            String        @id @default(cuid())
  orderNumber   String
  orderDate     DateTime
  deliveryDate  DateTime?
  totalAmount   Decimal
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  tenantId      String
  customerId    String
  userId        String
  invoices      Invoice[]
  items         OrderItem[]
  customer      Customer      @relation(fields: [customerId], references: [id])
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id])

  @@unique([tenantId, orderNumber])
  @@map("orders")
}

model OrderItem {
  id         String  @id @default(cuid())
  quantity   Int
  unitPrice  Decimal
  totalPrice Decimal
  discount   Decimal @default(0)
  orderId    String
  productId  String
  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String
  invoiceDate   DateTime
  dueDate       DateTime
  totalAmount   Decimal
  paidAmount    Decimal       @default(0)
  status        InvoiceStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  orderId       String
  order         Order         @relation(fields: [orderId], references: [id])

  @@map("invoices")
}

model Campaign {
  id          String             @id @default(cuid())
  name        String
  description String?
  type        String?
  startDate   DateTime
  endDate     DateTime
  budget      Decimal?
  status      CampaignStatus     @default(ACTIVE)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  tenantId    String
  tenant      Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  activities  PromoterActivity[]
  surveys     Survey[]

  @@map("campaigns")
}

model PromoterActivity {
  id                 String         @id @default(cuid())
  activityType       String
  location           String
  startTime          DateTime
  endTime            DateTime?
  samplesDistributed Int            @default(0)
  contactsMade       Int            @default(0)
  surveysCompleted   Int            @default(0)
  photos             Json?
  notes              String?
  status             ActivityStatus @default(PENDING)
  verificationScore  Decimal?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  userId             String
  campaignId         String?
  campaign           Campaign?      @relation(fields: [campaignId], references: [id])
  user               User           @relation(fields: [userId], references: [id])

  @@map("promoter_activities")
}

model Store {
  id          String               @id @default(cuid())
  code        String
  name        String
  address     String?
  city        String?
  state       String?
  coordinates Json?
  storeType   String?
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  tenantId    String
  visits      MerchandisingVisit[]
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@map("stores")
}

model MerchandisingVisit {
  id              String      @id @default(cuid())
  visitDate       DateTime
  shelfShare      Decimal?
  facingsCount    Int?
  complianceScore Decimal?
  issuesFound     Json?
  photos          Json?
  notes           String?
  status          VisitStatus @default(COMPLETED)
  aiScore         Decimal?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  userId          String
  storeId         String
  store           Store       @relation(fields: [storeId], references: [id])
  user            User        @relation(fields: [userId], references: [id])

  @@map("merchandising_visits")
}

model SimDistribution {
  id               String           @id @default(cuid())
  customerName     String
  customerPhone    String
  customerType     String
  simNumber        String
  activationCode   String
  location         String
  distributionDate DateTime
  kycStatus        KycStatus        @default(PENDING)
  activationStatus ActivationStatus @default(PENDING)
  commission       Decimal
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  userId           String
  user             User             @relation(fields: [userId], references: [id])

  @@map("sim_distributions")
}

model Inventory {
  id           String              @id @default(cuid())
  currentStock Int
  minStock     Int
  maxStock     Int
  location     String?
  lastMovement DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  tenantId     String
  productId    String
  product      Product             @relation(fields: [productId], references: [id])
  tenant       Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  movements    InventoryMovement[]

  @@unique([tenantId, productId, location])
  @@map("inventories")
}

model InventoryMovement {
  id           String       @id @default(cuid())
  movementType MovementType
  quantity     Int
  reason       String?
  reference    String?
  createdAt    DateTime     @default(now())
  inventoryId  String
  inventory    Inventory    @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@map("inventory_movements")
}

model Commission {
  id               String           @id @default(cuid())
  period           String
  baseSalary       Decimal
  salesAmount      Decimal
  commissionRate   Decimal
  commissionAmount Decimal
  bonuses          Decimal          @default(0)
  deductions       Decimal          @default(0)
  totalEarnings    Decimal
  status           CommissionStatus @default(PENDING)
  paymentDate      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  userId           String
  user             User             @relation(fields: [userId], references: [id])

  @@map("commissions")
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model FileUpload {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  url          String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@map("file_uploads")
}

model Survey {
  id             String           @id @default(cuid())
  title          String
  description    String?
  type           SurveyType
  targetAudience String
  startDate      DateTime
  endDate        DateTime?
  status         SurveyStatus
  isAnonymous    Boolean          @default(false)
  allowMultiple  Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  campaignId     String?
  tenantId       String
  createdById    String
  questions      SurveyQuestion[]
  responses      SurveyResponse[]
  campaign       Campaign?        @relation(fields: [campaignId], references: [id])
  createdBy      User             @relation("SurveyCreator", fields: [createdById], references: [id])
  tenant         Tenant           @relation(fields: [tenantId], references: [id])

  @@map("surveys")
}

model SurveyQuestion {
  id           String         @id @default(cuid())
  surveyId     String
  questionText String
  questionType QuestionType
  options      Json?
  isRequired   Boolean        @default(false)
  order        Int
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  answers      SurveyAnswer[]
  survey       Survey         @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@map("survey_questions")
}

model SurveyResponse {
  id           String         @id @default(cuid())
  surveyId     String
  respondentId String?
  submittedAt  DateTime       @default(now())
  location     String?
  deviceInfo   Json?
  answers      SurveyAnswer[]
  respondent   User?          @relation("SurveyRespondent", fields: [respondentId], references: [id])
  survey       Survey         @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@map("survey_responses")
}

model SurveyAnswer {
  id          String         @id @default(cuid())
  responseId  String
  questionId  String
  answerText  String?
  answerValue Json?
  createdAt   DateTime       @default(now())
  question    SurveyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  response    SurveyResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@map("survey_answers")
}

model Notification {
  id          String            @id @default(cuid())
  title       String
  message     String
  type        NotificationType  @default(INFO)
  priority    NotificationPriority @default(NORMAL)
  isRead      Boolean           @default(false)
  readAt      DateTime?
  data        Json?             // Additional data payload
  userId      String?           // Specific user notification
  tenantId    String?           // Tenant-wide notification
  roleTarget  UserRole?         // Role-based notification
  expiresAt   DateTime?         // Optional expiration
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  user        User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant      Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([tenantId, isRead])
  @@index([roleTarget, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  MANAGER
  VAN_SALES_AGENT
  PROMOTER
  MERCHANDISER
  FIELD_AGENT
  WAREHOUSE_STAFF
  BACK_OFFICE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum CustomerType {
  RETAIL
  WHOLESALE
  DISTRIBUTOR
  CORPORATE
}

enum RouteStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum StopStatus {
  PENDING
  VISITED
  SKIPPED
  FAILED
}

enum LoadStatus {
  LOADED
  IN_TRANSIT
  DELIVERED
  RECONCILED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  REFUNDED
}

enum InvoiceStatus {
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum ActivityStatus {
  PENDING
  VERIFIED
  APPROVED
  REJECTED
}

enum VisitStatus {
  COMPLETED
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum ActivationStatus {
  PENDING
  ACTIVATED
  FAILED
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  DISPUTED
}

enum SurveyType {
  CUSTOMER_SATISFACTION
  MARKET_RESEARCH
  PRODUCT_FEEDBACK
  BRAND_AWARENESS
  COMPETITOR_ANALYSIS
  MYSTERY_SHOPPING
  CUSTOM
}

enum SurveyStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum QuestionType {
  MULTIPLE_CHOICE
  SINGLE_CHOICE
  TEXT
  RATING
  YES_NO
  SCALE
  DATE
  FILE_UPLOAD
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
  ALERT
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}
