version: '3.8'

services:
  # PostgreSQL Master Database
  postgres-master:
    image: postgres:15-alpine
    container_name: salessync-postgres-master
    environment:
      POSTGRES_DB: salessync_tier1
      POSTGRES_USER: salessync_admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-SalesSync2024!}
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${REPLICATION_PASSWORD:-Repl2024!}
    ports:
      - "5432:5432"
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
      - ./postgresql-tier1-complete.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./postgresql-master.conf:/etc/postgresql/postgresql.conf
      - ./pg_hba.conf:/etc/postgresql/pg_hba.conf
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
    networks:
      - salessync-tier1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U salessync_admin -d salessync_tier1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Read Replica 1
  postgres-replica1:
    image: postgres:15-alpine
    container_name: salessync-postgres-replica1
    environment:
      POSTGRES_USER: salessync_admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-SalesSync2024!}
      PGUSER: salessync_admin
      POSTGRES_DB: salessync_tier1
      POSTGRES_MASTER_SERVICE: postgres-master
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${REPLICATION_PASSWORD:-Repl2024!}
    ports:
      - "5433:5432"
    volumes:
      - postgres_replica1_data:/var/lib/postgresql/data
      - ./postgresql-replica.conf:/etc/postgresql/postgresql.conf
      - ./setup-replica.sh:/docker-entrypoint-initdb.d/setup-replica.sh
    depends_on:
      postgres-master:
        condition: service_healthy
    networks:
      - salessync-tier1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U salessync_admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Read Replica 2
  postgres-replica2:
    image: postgres:15-alpine
    container_name: salessync-postgres-replica2
    environment:
      POSTGRES_USER: salessync_admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-SalesSync2024!}
      PGUSER: salessync_admin
      POSTGRES_DB: salessync_tier1
      POSTGRES_MASTER_SERVICE: postgres-master
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${REPLICATION_PASSWORD:-Repl2024!}
    ports:
      - "5434:5432"
    volumes:
      - postgres_replica2_data:/var/lib/postgresql/data
      - ./postgresql-replica.conf:/etc/postgresql/postgresql.conf
      - ./setup-replica.sh:/docker-entrypoint-initdb.d/setup-replica.sh
    depends_on:
      postgres-master:
        condition: service_healthy
    networks:
      - salessync-tier1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U salessync_admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PgBouncer Connection Pooler
  pgbouncer:
    image: pgbouncer/pgbouncer:latest
    container_name: salessync-pgbouncer
    environment:
      DATABASES_HOST: postgres-master
      DATABASES_PORT: 5432
      DATABASES_USER: salessync_admin
      DATABASES_PASSWORD: ${POSTGRES_PASSWORD:-SalesSync2024!}
      DATABASES_DBNAME: salessync_tier1
      POOL_MODE: transaction
      SERVER_RESET_QUERY: DISCARD ALL
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 25
      MIN_POOL_SIZE: 5
      RESERVE_POOL_SIZE: 5
      SERVER_LIFETIME: 3600
      SERVER_IDLE_TIMEOUT: 600
      LOG_CONNECTIONS: 1
      LOG_DISCONNECTIONS: 1
    ports:
      - "6432:5432"
    volumes:
      - ./pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini
      - ./userlist.txt:/etc/pgbouncer/userlist.txt
    depends_on:
      postgres-master:
        condition: service_healthy
    networks:
      - salessync-tier1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "psql -h localhost -p 5432 -U salessync_admin -d pgbouncer -c 'SHOW POOLS;' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Caching
  redis-master:
    image: redis:7-alpine
    container_name: salessync-redis-master
    ports:
      - "6379:6379"
    volumes:
      - redis_master_data:/data
      - ./redis-master.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - salessync-tier1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Replica
  redis-replica:
    image: redis:7-alpine
    container_name: salessync-redis-replica
    ports:
      - "6380:6379"
    volumes:
      - redis_replica_data:/data
      - ./redis-replica.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - salessync-tier1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Sentinel for High Availability
  redis-sentinel:
    image: redis:7-alpine
    container_name: salessync-redis-sentinel
    ports:
      - "26379:26379"
    volumes:
      - ./redis-sentinel.conf:/usr/local/etc/redis/sentinel.conf
    command: redis-sentinel /usr/local/etc/redis/sentinel.conf
    depends_on:
      - redis-master
      - redis-replica
    networks:
      - salessync-tier1
    restart: unless-stopped

  # PostgreSQL Backup Service
  postgres-backup:
    image: postgres:15-alpine
    container_name: salessync-postgres-backup
    environment:
      POSTGRES_HOST: postgres-master
      POSTGRES_DB: salessync_tier1
      POSTGRES_USER: salessync_admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-SalesSync2024!}
      BACKUP_SCHEDULE: "0 2 * * *"  # Daily at 2 AM
      BACKUP_RETENTION_DAYS: 30
    volumes:
      - postgres_backups:/backups
      - ./backup-script.sh:/usr/local/bin/backup-script.sh
      - ./restore-script.sh:/usr/local/bin/restore-script.sh
    command: >
      sh -c "
        chmod +x /usr/local/bin/backup-script.sh &&
        chmod +x /usr/local/bin/restore-script.sh &&
        echo '${BACKUP_SCHEDULE} /usr/local/bin/backup-script.sh' | crontab - &&
        crond -f
      "
    depends_on:
      postgres-master:
        condition: service_healthy
    networks:
      - salessync-tier1
    restart: unless-stopped

  # Prometheus for Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: salessync-prometheus
    ports:
      - "9090:9090"
    volumes:
      - prometheus_data:/prometheus
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - salessync-tier1
    restart: unless-stopped

  # Grafana for Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: salessync-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin123}
      GF_USERS_ALLOW_SIGN_UP: false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    networks:
      - salessync-tier1
    restart: unless-stopped

  # PostgreSQL Exporter for Prometheus
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: salessync-postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://salessync_admin:${POSTGRES_PASSWORD:-SalesSync2024!}@postgres-master:5432/salessync_tier1?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      postgres-master:
        condition: service_healthy
    networks:
      - salessync-tier1
    restart: unless-stopped

  # Redis Exporter for Prometheus
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: salessync-redis-exporter
    environment:
      REDIS_ADDR: "redis://redis-master:6379"
    ports:
      - "9121:9121"
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - salessync-tier1
    restart: unless-stopped

volumes:
  postgres_master_data:
    driver: local
  postgres_replica1_data:
    driver: local
  postgres_replica2_data:
    driver: local
  postgres_backups:
    driver: local
  redis_master_data:
    driver: local
  redis_replica_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  salessync-tier1:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16