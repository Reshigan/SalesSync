const express = require('express');
const router = express.Router();
const { v4: uuidv4 } = require('uuid');
// const { authTenantMiddleware } = require('../middleware/authTenantMiddleware');

// Apply authentication middleware to all routes
// router.use(authTenantMiddleware);

/**
 * @swagger
 * components:
 *   schemas:
 *     Warehouse:
 *       type: object
 *       required:
 *         - code
 *         - name
 *         - type
 *         - address
 *         - city
 *         - province
 *         - postal_code
 *         - contact_person
 *         - phone
 *         - email
 *         - capacity
 *       properties:
 *         id:
 *           type: string
 *           description: Unique identifier for the warehouse
 *         code:
 *           type: string
 *           description: Warehouse code
 *         name:
 *           type: string
 *           description: Warehouse name
 *         type:
 *           type: string
 *           enum: [main, regional, distribution, cold_storage]
 *           description: Warehouse type
 *         address:
 *           type: string
 *           description: Street address
 *         city:
 *           type: string
 *           description: City
 *         province:
 *           type: string
 *           description: Province
 *         postal_code:
 *           type: string
 *           description: Postal code
 *         manager_id:
 *           type: string
 *           description: ID of the warehouse manager
 *         contact_person:
 *           type: string
 *           description: Contact person name
 *         phone:
 *           type: string
 *           description: Phone number
 *         email:
 *           type: string
 *           description: Email address
 *         capacity:
 *           type: integer
 *           description: Storage capacity
 *         current_stock:
 *           type: integer
 *           description: Current stock level
 *         status:
 *           type: string
 *           enum: [active, inactive, maintenance]
 *           description: Warehouse status
 *         operating_hours:
 *           type: string
 *           description: Operating hours
 *         coordinates:
 *           type: object
 *           properties:
 *             lat:
 *               type: number
 *             lng:
 *               type: number
 *         created_at:
 *           type: string
 *           format: date-time
 *         updated_at:
 *           type: string
 *           format: date-time
 */

/**
 * @swagger
 * /api/warehouses:
 *   get:
 *     summary: Get all warehouses
 *     tags: [Warehouses]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: List of warehouses
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/Warehouse'
 */
router.get('/', async (req, res) => {
  try {
    const { db } = req;
    
    const query = `
      SELECT 
        w.*,
        u.firstName || ' ' || u.lastName as manager_name,
        COALESCE(stock.current_stock, 0) as current_stock
      FROM warehouses w
      LEFT JOIN users u ON w.manager_id = u.id
      LEFT JOIN (
        SELECT warehouse_id, SUM(quantity) as current_stock
        FROM inventory
        GROUP BY warehouse_id
      ) stock ON w.id = stock.warehouse_id
      WHERE w.tenant_id = ?
      ORDER BY w.name
    `;
    
    const warehouses = db.prepare(query).all(req.tenantId);
    
    // Parse coordinates JSON if exists
    warehouses.forEach(warehouse => {
      if (warehouse.coordinates) {
        try {
          warehouse.coordinates = JSON.parse(warehouse.coordinates);
        } catch (e) {
          warehouse.coordinates = null;
        }
      }
    });
    
    res.json({
      success: true,
      data: warehouses
    });
  } catch (error) {
    console.error('Error fetching warehouses:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch warehouses'
    });
  }
});

/**
 * @swagger
 * /api/warehouses/{id}:
 *   get:
 *     summary: Get warehouse by ID
 *     tags: [Warehouses]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: Warehouse details
 *       404:
 *         description: Warehouse not found
 */
router.get('/:id', async (req, res) => {
  try {
    const { db } = req;
    const { id } = req.params;
    
    const query = `
      SELECT 
        w.*,
        u.firstName || ' ' || u.lastName as manager_name
      FROM warehouses w
      LEFT JOIN users u ON w.manager_id = u.id
      WHERE w.id = ? AND w.tenant_id = ?
    `;
    
    const warehouse = db.prepare(query).get(id, req.tenantId);
    
    if (!warehouse) {
      return res.status(404).json({
        success: false,
        error: 'Warehouse not found'
      });
    }
    
    // Parse coordinates JSON if exists
    if (warehouse.coordinates) {
      try {
        warehouse.coordinates = JSON.parse(warehouse.coordinates);
      } catch (e) {
        warehouse.coordinates = null;
      }
    }
    
    res.json({
      success: true,
      data: warehouse
    });
  } catch (error) {
    console.error('Error fetching warehouse:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch warehouse'
    });
  }
});

/**
 * @swagger
 * /api/warehouses:
 *   post:
 *     summary: Create new warehouse
 *     tags: [Warehouses]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - code
 *               - name
 *               - type
 *               - address
 *               - city
 *               - province
 *               - postal_code
 *               - contact_person
 *               - phone
 *               - email
 *               - capacity
 *             properties:
 *               code:
 *                 type: string
 *               name:
 *                 type: string
 *               type:
 *                 type: string
 *                 enum: [main, regional, distribution, cold_storage]
 *               address:
 *                 type: string
 *               city:
 *                 type: string
 *               province:
 *                 type: string
 *               postal_code:
 *                 type: string
 *               manager_id:
 *                 type: string
 *               contact_person:
 *                 type: string
 *               phone:
 *                 type: string
 *               email:
 *                 type: string
 *               capacity:
 *                 type: integer
 *               status:
 *                 type: string
 *                 enum: [active, inactive, maintenance]
 *               operating_hours:
 *                 type: string
 *               coordinates:
 *                 type: object
 *                 properties:
 *                   lat:
 *                     type: number
 *                   lng:
 *                     type: number
 *     responses:
 *       201:
 *         description: Warehouse created successfully
 *       400:
 *         description: Invalid input
 */
router.post('/', async (req, res) => {
  try {
    const { db } = req;
    const { 
      code, name, type, address, city, province, postal_code,
      manager_id, contact_person, phone, email, capacity,
      status = 'active', operating_hours, coordinates
    } = req.body;
    
    // Validate required fields
    if (!code || !name || !type || !address || !city || !province || !postal_code || 
        !contact_person || !phone || !email || !capacity) {
      return res.status(400).json({
        success: false,
        error: 'All required fields must be provided'
      });
    }
    
    // Check if code already exists
    const existingWarehouse = db.prepare('SELECT id FROM warehouses WHERE code = ? AND tenant_id = ?').get(code, req.tenantId);
    if (existingWarehouse) {
      return res.status(400).json({
        success: false,
        error: 'Warehouse code already exists'
      });
    }
    
    const id = uuidv4();
    const now = new Date().toISOString();
    
    // Stringify coordinates if provided
    const coordinatesJson = coordinates ? JSON.stringify(coordinates) : null;
    
    const insertQuery = `
      INSERT INTO warehouses (
        id, tenant_id, code, name, type, address, city, province, postal_code,
        manager_id, contact_person, phone, email, capacity, status,
        operating_hours, coordinates, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;
    
    db.prepare(insertQuery).run(
      id, req.tenantId, code, name, type, address, city, province, postal_code,
      manager_id || null, contact_person, phone, email, capacity, status,
      operating_hours || null, coordinatesJson, now, now
    );
    
    // Fetch the created warehouse with joined data
    const query = `
      SELECT 
        w.*,
        u.firstName || ' ' || u.lastName as manager_name
      FROM warehouses w
      LEFT JOIN users u ON w.manager_id = u.id
      WHERE w.id = ?
    `;
    
    const warehouse = db.prepare(query).get(id);
    
    // Parse coordinates JSON if exists
    if (warehouse.coordinates) {
      try {
        warehouse.coordinates = JSON.parse(warehouse.coordinates);
      } catch (e) {
        warehouse.coordinates = null;
      }
    }
    
    res.status(201).json({
      success: true,
      data: warehouse
    });
  } catch (error) {
    console.error('Error creating warehouse:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to create warehouse'
    });
  }
});

/**
 * @swagger
 * /api/warehouses/{id}:
 *   put:
 *     summary: Update warehouse
 *     tags: [Warehouses]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               code:
 *                 type: string
 *               name:
 *                 type: string
 *               type:
 *                 type: string
 *                 enum: [main, regional, distribution, cold_storage]
 *               address:
 *                 type: string
 *               city:
 *                 type: string
 *               province:
 *                 type: string
 *               postal_code:
 *                 type: string
 *               manager_id:
 *                 type: string
 *               contact_person:
 *                 type: string
 *               phone:
 *                 type: string
 *               email:
 *                 type: string
 *               capacity:
 *                 type: integer
 *               status:
 *                 type: string
 *                 enum: [active, inactive, maintenance]
 *               operating_hours:
 *                 type: string
 *               coordinates:
 *                 type: object
 *                 properties:
 *                   lat:
 *                     type: number
 *                   lng:
 *                     type: number
 *     responses:
 *       200:
 *         description: Warehouse updated successfully
 *       404:
 *         description: Warehouse not found
 */
router.put('/:id', async (req, res) => {
  try {
    const { db } = req;
    const { id } = req.params;
    const { 
      code, name, type, address, city, province, postal_code,
      manager_id, contact_person, phone, email, capacity,
      status, operating_hours, coordinates
    } = req.body;
    
    // Check if warehouse exists
    const existingWarehouse = db.prepare('SELECT id FROM warehouses WHERE id = ? AND tenant_id = ?').get(id, req.tenantId);
    if (!existingWarehouse) {
      return res.status(404).json({
        success: false,
        error: 'Warehouse not found'
      });
    }
    
    // Check if code already exists (excluding current warehouse)
    if (code) {
      const duplicateWarehouse = db.prepare('SELECT id FROM warehouses WHERE code = ? AND tenant_id = ? AND id != ?').get(code, req.tenantId, id);
      if (duplicateWarehouse) {
        return res.status(400).json({
          success: false,
          error: 'Warehouse code already exists'
        });
      }
    }
    
    const now = new Date().toISOString();
    
    // Stringify coordinates if provided
    const coordinatesJson = coordinates ? JSON.stringify(coordinates) : null;
    
    const updateQuery = `
      UPDATE warehouses SET
        code = COALESCE(?, code),
        name = COALESCE(?, name),
        type = COALESCE(?, type),
        address = COALESCE(?, address),
        city = COALESCE(?, city),
        province = COALESCE(?, province),
        postal_code = COALESCE(?, postal_code),
        manager_id = ?,
        contact_person = COALESCE(?, contact_person),
        phone = COALESCE(?, phone),
        email = COALESCE(?, email),
        capacity = COALESCE(?, capacity),
        status = COALESCE(?, status),
        operating_hours = ?,
        coordinates = ?,
        updated_at = ?
      WHERE id = ? AND tenant_id = ?
    `;
    
    db.prepare(updateQuery).run(
      code, name, type, address, city, province, postal_code,
      manager_id || null, contact_person, phone, email, capacity,
      status, operating_hours || null, coordinatesJson, now, id, req.tenantId
    );
    
    // Fetch the updated warehouse with joined data
    const query = `
      SELECT 
        w.*,
        u.firstName || ' ' || u.lastName as manager_name
      FROM warehouses w
      LEFT JOIN users u ON w.manager_id = u.id
      WHERE w.id = ?
    `;
    
    const warehouse = db.prepare(query).get(id);
    
    // Parse coordinates JSON if exists
    if (warehouse.coordinates) {
      try {
        warehouse.coordinates = JSON.parse(warehouse.coordinates);
      } catch (e) {
        warehouse.coordinates = null;
      }
    }
    
    res.json({
      success: true,
      data: warehouse
    });
  } catch (error) {
    console.error('Error updating warehouse:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update warehouse'
    });
  }
});

/**
 * @swagger
 * /api/warehouses/{id}:
 *   delete:
 *     summary: Delete warehouse
 *     tags: [Warehouses]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: Warehouse deleted successfully
 *       404:
 *         description: Warehouse not found
 *       400:
 *         description: Cannot delete warehouse with associated inventory
 */
router.delete('/:id', async (req, res) => {
  try {
    const { db } = req;
    const { id } = req.params;
    
    // Check if warehouse exists
    const existingWarehouse = db.prepare('SELECT id FROM warehouses WHERE id = ? AND tenant_id = ?').get(id, req.tenantId);
    if (!existingWarehouse) {
      return res.status(404).json({
        success: false,
        error: 'Warehouse not found'
      });
    }
    
    // Check if warehouse has associated inventory
    const inventoryCount = db.prepare('SELECT COUNT(*) as count FROM inventory WHERE warehouse_id = ?').get(id);
    if (inventoryCount.count > 0) {
      return res.status(400).json({
        success: false,
        error: 'Cannot delete warehouse with associated inventory'
      });
    }
    
    db.prepare('DELETE FROM warehouses WHERE id = ? AND tenant_id = ?').run(id, req.tenantId);
    
    res.json({
      success: true,
      message: 'Warehouse deleted successfully'
    });
  } catch (error) {
    console.error('Error deleting warehouse:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to delete warehouse'
    });
  }
});

module.exports = router;
